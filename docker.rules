# fapolicyd rules for Docker
# This file allows execution of all Docker-related binaries
# Place this file in /etc/fapolicyd/rules.d/ (e.g., as 50-docker.rules)
# After adding, run: sudo fagenrules --load

# Docker CLI binary (common locations)
allow perm=execute exe=/usr/bin/docker : all
allow perm=execute exe=/usr/local/bin/docker : all
allow perm=execute exe=/bin/docker : all

# Docker daemon binary
allow perm=execute exe=/usr/bin/dockerd : all
allow perm=execute exe=/usr/local/bin/dockerd : all
allow perm=execute exe=/bin/dockerd : all

# Docker Compose
allow perm=execute exe=/usr/bin/docker-compose : all
allow perm=execute exe=/usr/local/bin/docker-compose : all
allow perm=execute exe=/bin/docker-compose : all

# containerd (container runtime)
allow perm=execute exe=/usr/bin/containerd : all
allow perm=execute exe=/usr/local/bin/containerd : all
allow perm=execute exe=/bin/containerd : all
allow perm=execute exe=/usr/sbin/containerd : all

# containerd-shim (container runtime shim)
allow perm=execute exe=/usr/bin/containerd-shim : all
allow perm=execute exe=/usr/local/bin/containerd-shim : all
allow perm=execute exe=/usr/bin/containerd-shim-runc-v2 : all
allow perm=execute exe=/usr/bin/containerd-shim-runc-v1 : all

# runc (OCI runtime)
allow perm=execute exe=/usr/bin/runc : all
allow perm=execute exe=/usr/local/bin/runc : all
allow perm=execute exe=/usr/sbin/runc : all
allow perm=execute exe=/bin/runc : all

# ctr (containerd CLI)
allow perm=execute exe=/usr/bin/ctr : all
allow perm=execute exe=/usr/local/bin/ctr : all

# Docker rootless binaries
allow perm=execute exe=/usr/bin/docker-rootless-setuptool.sh : all
allow perm=execute exe=/usr/bin/docker-rootless.sh : all
allow perm=execute exe=/usr/local/bin/docker-rootless-setuptool.sh : all
allow perm=execute exe=/usr/local/bin/docker-rootless.sh : all

# Docker buildx plugin
allow perm=execute exe=/usr/bin/docker-buildx : all
allow perm=execute exe=/usr/local/bin/docker-buildx : all
allow perm=execute exe=/usr/libexec/docker/docker-buildx : all

# Docker scan plugin
allow perm=execute exe=/usr/bin/docker-scan : all
allow perm=execute exe=/usr/local/bin/docker-scan : all

# Docker init (for init containers)
allow perm=execute exe=/usr/bin/docker-init : all
allow perm=execute exe=/usr/local/bin/docker-init : all

# Docker proxy
allow perm=execute exe=/usr/bin/docker-proxy : all
allow perm=execute exe=/usr/local/bin/docker-proxy : all

# Allow execution from Docker's plugin directory
allow perm=execute dir=/usr/libexec/docker/ : all
allow perm=execute dir=/usr/local/libexec/docker/ : all
allow perm=execute dir=/var/lib/docker/plugins/ : all

# Allow execution from containerd plugin directories
allow perm=execute dir=/usr/libexec/containerd/ : all
allow perm=execute dir=/usr/local/libexec/containerd/ : all

# Allow execution from Docker rootless directory
allow perm=execute dir=/usr/local/libexec/docker/cli-plugins/ : all
allow perm=execute dir=/usr/libexec/docker/cli-plugins/ : all
allow perm=execute dir=/home/*/.local/share/docker/cli-plugins/ : all

# Allow execution of binaries in Docker's runtime directories
# (for container runtimes and shims)
allow perm=execute dir=/run/docker/ : all
allow perm=execute dir=/var/run/docker/ : all
allow perm=execute dir=/run/containerd/ : all
allow perm=execute dir=/var/run/containerd/ : all

# Allow execution from systemd service directories (Docker may use these)
allow perm=execute dir=/usr/lib/systemd/system/ : all
allow perm=execute dir=/etc/systemd/system/ : all

# Allow execution of any binary that Docker might spawn
# This is a broader rule - use with caution in production
# Consider restricting to specific paths if possible
allow perm=execute exe=/usr/bin/* : trust
allow perm=execute exe=/usr/local/bin/* : trust
allow perm=execute exe=/bin/* : trust
allow perm=execute exe=/sbin/* : trust
allow perm=execute exe=/usr/sbin/* : trust

# Note: The above wildcard rules are permissive. For stricter security,
# you may want to remove them and only allow specific binaries.
# However, Docker containers may need to execute various system binaries,
# so these rules ensure Docker functionality while maintaining some security.

